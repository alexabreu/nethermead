<header>
  <div class="container-fluid">
      <div class="row">
        <div class="col-md-12">
          <ol class="breadcrumb" id="main-breadcrumb">
            <li><a href="<%= url_for :controller => 'search', :action => 'show', :slug => @result.company.slug, :state => @result.state.state_name.downcase, :class => @result.product_class.abbr.downcase, :only_path => false %>">Market Summary</a></li>
            <li class="active">Map</li>
          </ol>
          <h2 class="pull-left">Company Heat Map</h2>
        </div>
      </div>
      <div class="row">
        <div class="col-md-12">
          <p class="summary">See the Nethermead analysis snapshot below. The Nethermead platform will allow healthcare companies to conduct deeper analysis of these items, run simulations and forecasts and generate plans for execution.
          </p>
        </div>
      </div>
  </div>
</header>

<div class="container-fluid container-padded  background-light-grey">
  <div class="row row-padded row-padded-top">
    <div class="col-md-12 result-title">
    <h3 class="grey pull-left tall"><%= @result.company.name_proper %></h3>
    <div class="circle-sm pull-left"><div class="product-class-abbr"><%= @result.product_class.abbr %></div></div>
    <span class="stateface stateface-replace stateface-<%= @result.state.abbreviation %> green pull-left"></span>
    <a class="pull-right edit-search" href="#"><span class="glyphicon glyphicon-pencil"></span> Edit</a>
    </div>
  </div>
</div>

<div id="company-search"></div>

<div class="container-fluid container-padded">
  <div class="row">
    <div class="col-md-9 state-map">
      

    </div>
    <div class="col-md-3">
      <h3 class="purple">County Results</h3>
      <p class="summary">County specific data points.</p>
    </div>
  </div>
</div>


<script type="text/javascript">
    $().ready(function() {
        var $company_search = $('#company-search');
        $company_search.hide();
        var company_search = new window.CompanySearch();
        var is_open = false;
        $('.edit-search').click(function(e) {
            e.preventDefault();
            if(is_open) {
                $company_search.slideUp();
            } else {
                $('#company-search').html(company_search.render().$el);
                company_search.prefill(
                        new window.Company(<%= @result.company.to_json.to_s.html_safe %>),
                        new window.Market(<%= @result.to_json(:include => [:product_class, :state]).to_s.html_safe %>
                        ));
                $company_search.slideDown();
            }
            is_open = !is_open;
            return false;
        });

        var $state_map = $('.state-map');

        var width = $state_map.width(),
        height = 600;

        var rateById = d3.map();

        var quantize = d3.scale.quantize()
            .domain([0, .15])
            .range(d3.range(9).map(function(i) { return "q" + i + "-9"; }));

        var projection = d3.geo.albersUsa()
            .scale(width)
            .translate([width / 2, height / 2]);

        var path = d3.geo.path()
            .projection(projection);

        var svg = d3.select(".state-map").append("svg")
            .attr("width", width)
            .attr("height", height);

        queue()
            .defer(d3.json, "/assets/us.json")
            .await(ready);

        //.defer(d3.tsv, "unemployment.tsv", function(d) { rateById.set(d.id, +d.rate); })

        function ready(error, us) {
          svg.append("g")
              .attr("class", "counties")
            .selectAll("path")
              .data(topojson.feature(us, us.objects.counties).features)
            .enter().append("path")
              .attr("class", function(d) { return quantize(rateById.get(d.id)); })
              .attr("d", path);

          svg.append("path")
              .datum(topojson.mesh(us, us.objects.states, function(a, b) { return a !== b; }))
              .attr("class", "states")
              .attr("d", path);
        }

        d3.select(self.frameElement).style("height", height + "px");
    });
</script>